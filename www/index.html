<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <meta http-equiv="Content-Security-Policy" content="default-src * data:; media-src * blob:; style-src * 'unsafe-inline'; script-src * 'unsafe-inline' 'unsafe-eval'">
  <script src="components/loader.js"></script>
  <script src="lib/onsenui/js/onsenui.min.js"></script>

  <link rel="stylesheet" href="components/loader.css">
  <link rel="stylesheet" href="lib/onsenui/css/onsenui.css">
  <link rel="stylesheet" href="lib/onsenui/css/onsen-css-components.css">
  <link rel="stylesheet" href="css/style.css">

  <script>
  	// パラメータ
		var userName = "YOUR_API_KEY";
		var url  = "https://api.voicetext.jp/v1/tts";
		var params   = {
			speaker: "hikari",
			text: ""
		};
		
    ons.ready(function() {
    	// 初期表示
    	var audio = $("#audio");
      audio.hide();
      
      // 音声に変換ボタンを押した時のイベント
      $("#tts").on("click", function() {
      	audio.hide();
      	
      	// テキスト取得
      	params.text = $("#text").val();
      	
      	// XMLHttpRequestの準備
      	var xhr = new XMLHttpRequest();
				xhr.onreadystatechange = function(){
					// アクセスが返ってきたらここ
					if (this.readyState == 4 && this.status == 200){
						audio.attr("src", window.URL.createObjectURL(this.response));
						audio.show();
					}
				}
				
				// パラメータをフォーム送信用にエンコーディング
				var data = [];
				for (var key in params) {
					var value = encodeURIComponent(key) + '=' + encodeURIComponent(params[key]);
					data.push(value);
				}
				var serialize = data.join('&').replace(/%20/g, '+');
				
				// XMLHttpRequestを使ってアクセス
				var basicBase64 = btoa(unescape(encodeURIComponent(userName + ":")));
				xhr.open('POST', url);
				xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
				xhr.setRequestHeader("Authorization", "Basic " + basicBase64);
				xhr.responseType = 'blob';
				xhr.send(serialize);
      });
    });
  </script>
</head>
<body>
	<ons-page>
		<ons-toolbar>
	    <div class="center">テキストを音声変換</div>
	  </ons-toolbar>

	  <section style="padding: 8px">
	  	<p>
		    <textarea id="text" class="textarea">こんにちは</textarea>
	    </p>
	    <br>
	    <ons-button id="tts" modifier="large">音声に変換</ons-button>
	    <p></p>
	    <p><audio id="audio" controls></audio></p>
	  </section>
	</ons-page>
</body>
</html>
